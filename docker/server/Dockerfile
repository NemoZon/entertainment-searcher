FROM node:18-alpine

# CrÃ©e un dossier de travail propre
WORKDIR /app

# Copie les fichiers de dÃ©pendances
COPY server/package*.json ./

# Installation des dÃ©pendances
RUN npm install

# Copie du reste de lâ€™application
COPY server/ .

# GÃ©nÃ©ration du client Prisma
RUN npx prisma generate

EXPOSE 3000

# DÃ©marrage avec attente DB + migration + seed + nodemon
CMD sh -c "until nc -z db 5432; do echo 'â³ Attente de la base de donnÃ©es...'; sleep 1; done && \
  echo 'âœ… DB prÃªte ! Migration...' && \
  npx prisma migrate deploy && \
  echo 'ğŸŒ± Seed...' && \
  npm run seed && \
  echo 'ğŸš€ Lancement du serveur...' && \
  npm run dev"
