FROM node:18-alpine

WORKDIR /app

# Installation des dÃ©pendances
COPY server/package.json server/package-lock.json ./
RUN npm install

# Copie du code source
COPY server/ .

# GÃ©nÃ©ration du client Prisma
RUN npx prisma generate

# Exposition du port
EXPOSE 3000

# DÃ©marrage avec initialisation DB + seed + serveur
CMD sh -c "until nc -z db 5432; do echo 'â³ Attente de la base de donnÃ©es...'; sleep 1; done && \
  echo 'âœ… DB prÃªte ! Migration...' && \
  npx prisma migrate deploy && \
  echo 'Seed...' && \
  npm run seed && \
  echo 'ğŸš€ Lancement du serveur...' && \
  npm run dev"
